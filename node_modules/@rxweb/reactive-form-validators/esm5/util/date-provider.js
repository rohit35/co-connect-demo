import * as tslib_1 from "tslib";
import { ReactiveFormConfig } from "./reactive-form-config";
import { ApplicationUtil } from './app-util';
var ISO_DATE_REGEX = /^(\d{4}-\d{1,2}-\d{1,2})$/;
var DateProvider = /** @class */ (function () {
    function DateProvider() {
    }
    DateProvider.prototype.isDate = function (value) {
        return value instanceof Date && !isNaN(value.valueOf());
    };
    DateProvider.prototype.getRegex = function (dateFormat) {
        var regExp;
        switch (dateFormat) {
            case 'ymd':
                regExp = "^(?:[0-9]{4})-(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])$";
                break;
            case 'dmy':
                regExp = "^(3[01]|[12][0-9]|0?[1-9])-(1[0-2]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
            case 'mdy':
                regExp = "^(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
        }
        return new RegExp(regExp);
    };
    DateProvider.prototype.regex = function () {
        var regExp;
        if (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator)
            regExp = this.getRegex(ReactiveFormConfig.json.internationalization.dateFormat);
        else
            regExp = (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat) ? this.getRegex(ReactiveFormConfig.json.baseConfig.dateFormat) : this.getRegex("mdy");
        return regExp;
    };
    DateProvider.prototype.getDate = function (value, isBaseFormat) {
        var _a, _b, _c;
        if (isBaseFormat === void 0) { isBaseFormat = false; }
        var year, month, day;
        if (!this.isDate(value)) {
            var seperator = void 0;
            var dateFormat = void 0;
            if (ISO_DATE_REGEX.test(value)) {
                seperator = "-";
                dateFormat = "ymd";
            }
            else {
                seperator = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.seperator ? ReactiveFormConfig.json.baseConfig.seperator : "/";
                dateFormat = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat ? ReactiveFormConfig.json.baseConfig.dateFormat : "mdy";
            }
            if (!isBaseFormat && ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator) {
                seperator = ReactiveFormConfig.json.internationalization.seperator;
                dateFormat = ReactiveFormConfig.json.internationalization.dateFormat;
            }
            switch (dateFormat) {
                case 'ymd':
                    _a = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), year = _a[0], month = _a[1], day = _a[2];
                    break;
                case 'dmy':
                    _b = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), day = _b[0], month = _b[1], year = _b[2];
                    break;
                case 'mdy':
                    _c = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), month = _c[0], day = _c[1], year = _c[2];
                    break;
            }
            return new Date(year, month - 1, day);
        }
        else
            return value;
    };
    DateProvider.prototype.isValid = function (value, config) {
        if (typeof value == "string") {
            // Fixed issue : https://github.com/rxweb/rxweb/issues/280 & feature request : https://github.com/rxweb/rxweb/issues/295
            if (config && config.allowISODate && ISO_DATE_REGEX.test(value))
                return true;
            var seperator = '/';
            if (ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.seperator)
                seperator = ReactiveFormConfig.json.internationalization.seperator;
            value = value.replace(seperator, '-').replace(seperator, '-');
            return this.regex().test(value);
        }
        else
            return this.isDate(value);
    };
    DateProvider.prototype.getConfigDateValue = function (config) {
        var date = config.value;
        if (config.value && typeof config.value == "string") {
            date = this.getDate(config.value, true);
        }
        return date;
    };
    DateProvider.prototype.getCompareDate = function (config, control) {
        var date = this.getConfigDateValue(config);
        if (config.fieldName) {
            var checkControl = ApplicationUtil.getFormControl(config.fieldName, control);
            if (checkControl && checkControl.value) {
                date = this.getDate(checkControl.value);
            }
        }
        return date;
    };
    return DateProvider;
}());
export { DateProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJ1dGlsL2RhdGUtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBQyxlQUFlLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFDM0MsSUFBTSxjQUFjLEdBQUcsMkJBQTJCLENBQUM7QUFDbkQ7SUFBQTtJQWlHQSxDQUFDO0lBL0ZDLDZCQUFNLEdBQU4sVUFBTyxLQUFVO1FBQ2YsT0FBTyxLQUFLLFlBQVksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFUywrQkFBUSxHQUFoQixVQUFpQixVQUFpQjtRQUNoQyxJQUFJLE1BQWEsQ0FBQztRQUNsQixRQUFPLFVBQVUsRUFBQztZQUNaLEtBQUssS0FBSztnQkFDVixNQUFNLEdBQUcsMkRBQTJELENBQUM7Z0JBQ3JFLE1BQU07WUFDTixLQUFLLEtBQUs7Z0JBQ1YsTUFBTSxHQUFHLG9FQUFvRSxDQUFDO2dCQUM5RSxNQUFNO1lBQ04sS0FBSyxLQUFLO2dCQUNWLE1BQU0sR0FBRyxvRUFBb0UsQ0FBQztnQkFDOUUsTUFBTTtTQUNYO1FBQ0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRUQsNEJBQUssR0FBTDtRQUNFLElBQUksTUFBYSxDQUFDO1FBQ2xCLElBQUcsa0JBQWtCLElBQUksa0JBQWtCLENBQUMsSUFBSSxJQUFJLGtCQUFrQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxJQUFLLGtCQUFrQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTO1lBQ3BO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QyxJQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUM7WUFDbEIsSUFBSSxZQUFZLEdBQVMsZUFBZSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hGLElBQUcsWUFBWSxJQUFJLFlBQVksQ0FBQyxLQUFLLEVBQUM7Z0JBQ2xDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTthQUN0QztTQUNGO1FBQ1QsT0FBTyxJQUFJLENBQUM7SUFDbEIsQ0FBQztJQUNILG1CQUFDO0FBQUQsQ0FBQyxBQWpHRCxJQWlHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlYWN0aXZlRm9ybUNvbmZpZyB9IGZyb20gXCIuL3JlYWN0aXZlLWZvcm0tY29uZmlnXCI7XHJcbmltcG9ydCB7QXBwbGljYXRpb25VdGlsIH0gZnJvbSAnLi9hcHAtdXRpbCdcclxuY29uc3QgSVNPX0RBVEVfUkVHRVggPSAvXihcXGR7NH0tXFxkezEsMn0tXFxkezEsMn0pJC87XHJcbmV4cG9ydCBjbGFzcyBEYXRlUHJvdmlkZXJ7XHJcblxyXG4gIGlzRGF0ZSh2YWx1ZTogYW55KTogQm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTih2YWx1ZS52YWx1ZU9mKCkpO1xyXG4gIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFJlZ2V4KGRhdGVGb3JtYXQ6c3RyaW5nKSA6IFJlZ0V4cHtcclxuICAgICAgdmFyIHJlZ0V4cDpzdHJpbmc7XHJcbiAgICAgIHN3aXRjaChkYXRlRm9ybWF0KXtcclxuICAgICAgICAgICAgY2FzZSAneW1kJzpcclxuICAgICAgICAgICAgcmVnRXhwID0gXCJeKD86WzAtOV17NH0pLSgxWzAtMl18MD9bMS05XSktKDNbMDFdfFsxMl1bMC05XXwwP1sxLTldKSRcIjtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2RteSc6XHJcbiAgICAgICAgICAgIHJlZ0V4cCA9IFwiXigzWzAxXXxbMTJdWzAtOV18MD9bMS05XSktKDFbMC0yXXwwP1sxLTldKS0oPzpbMC05XXsyfSk/WzAtOV17Mn0kXCI7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtZHknOlxyXG4gICAgICAgICAgICByZWdFeHAgPSBcIl4oMVswLTJdfDA/WzEtOV0pLSgzWzAxXXxbMTJdWzAtOV18MD9bMS05XSktKD86WzAtOV17Mn0pP1swLTldezJ9JFwiO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gbmV3IFJlZ0V4cChyZWdFeHApO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2V4KCl7XHJcbiAgICAgIHZhciByZWdFeHA6UmVnRXhwO1xyXG4gICAgICBpZihSZWFjdGl2ZUZvcm1Db25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uZGF0ZUZvcm1hdCAgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uc2VwZXJhdG9yKVxyXG4gICAgICAgIHJlZ0V4cCA9IHRoaXMuZ2V0UmVnZXgoUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uZGF0ZUZvcm1hdClcclxuICAgICAgZWxzZVxyXG4gICAgICAgIHJlZ0V4cCA9IChSZWFjdGl2ZUZvcm1Db25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnLmRhdGVGb3JtYXQpID8gdGhpcy5nZXRSZWdleChSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnLmRhdGVGb3JtYXQpIDogdGhpcy5nZXRSZWdleChcIm1keVwiKTtcclxuICAgICAgcmV0dXJuIHJlZ0V4cDtcclxuICAgIH1cclxuXHJcbiAgZ2V0RGF0ZSh2YWx1ZTpzdHJpbmcgfCBEYXRlLGlzQmFzZUZvcm1hdDpib29sZWFuID0gZmFsc2UpOiBEYXRle1xyXG4gICAgbGV0IHllYXIsbW9udGgsZGF5O1xyXG4gICAgaWYoIXRoaXMuaXNEYXRlKHZhbHVlKSl7XHJcbiAgICAgIGxldCBzZXBlcmF0b3I6c3RyaW5nO1xyXG4gICAgICBsZXQgZGF0ZUZvcm1hdDpzdHJpbmc7XHJcbiAgICAgIGlmKElTT19EQVRFX1JFR0VYLnRlc3QoPHN0cmluZz52YWx1ZSkpe1xyXG4gICAgICAgIHNlcGVyYXRvciA9IFwiLVwiO1xyXG4gICAgICAgIGRhdGVGb3JtYXQgPSBcInltZFwiXHJcbiAgICAgIH1lbHNle1xyXG4gICAgICAgIHNlcGVyYXRvciA9IFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuc2VwZXJhdG9yID8gUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5zZXBlcmF0b3IgOiBcIi9cIjtcclxuICAgICAgICBkYXRlRm9ybWF0ID0gUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5kYXRlRm9ybWF0ID8gUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5kYXRlRm9ybWF0IDogXCJtZHlcIjtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgaWYoIWlzQmFzZUZvcm1hdCAmJiBSZWFjdGl2ZUZvcm1Db25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uZGF0ZUZvcm1hdCAgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uc2VwZXJhdG9yKVxyXG4gICAgICB7XHJcbiAgICAgICAgc2VwZXJhdG9yID0gUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uc2VwZXJhdG9yO1xyXG4gICAgICAgIGRhdGVGb3JtYXQgPSBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5kYXRlRm9ybWF0O1xyXG4gICAgICB9XHJcbiAgICAgICAgc3dpdGNoKGRhdGVGb3JtYXQpe1xyXG4gICAgICAgICAgICBjYXNlICd5bWQnOlxyXG4gICAgICAgICAgICBbeWVhciwgbW9udGgsIGRheV0gPSAoPFN0cmluZz52YWx1ZSkuc3BsaXQoc2VwZXJhdG9yKS5tYXAoKHZhbDogc3RyaW5nKSA9PiArdmFsKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2RteSc6XHJcbiAgICAgICAgICAgIFtkYXksbW9udGgseWVhcl0gPSAoPFN0cmluZz52YWx1ZSkuc3BsaXQoc2VwZXJhdG9yKS5tYXAoKHZhbDogc3RyaW5nKSA9PiArdmFsKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ21keSc6XHJcbiAgICAgICAgICAgIFttb250aCxkYXkseWVhcl0gPSAoPFN0cmluZz52YWx1ZSkuc3BsaXQoc2VwZXJhdG9yKS5tYXAoKHZhbDogc3RyaW5nKSA9PiArdmFsKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmV3IERhdGUoeWVhcixtb250aC0xLGRheSk7XHJcbiAgICB9ZWxzZVxyXG4gICAgICByZXR1cm4gPERhdGU+dmFsdWU7XHJcbiAgfVxyXG5cclxuICAgIGlzVmFsaWQodmFsdWU6IHN0cmluZyB8IERhdGUsIGNvbmZpZzogYW55KTogQm9vbGVhbntcclxuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAvLyBGaXhlZCBpc3N1ZSA6IGh0dHBzOi8vZ2l0aHViLmNvbS9yeHdlYi9yeHdlYi9pc3N1ZXMvMjgwICYgZmVhdHVyZSByZXF1ZXN0IDogaHR0cHM6Ly9naXRodWIuY29tL3J4d2ViL3J4d2ViL2lzc3Vlcy8yOTVcclxuICAgICAgaWYoY29uZmlnICYmIGNvbmZpZy5hbGxvd0lTT0RhdGUgJiYgSVNPX0RBVEVfUkVHRVgudGVzdCg8c3RyaW5nPnZhbHVlKSlcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgbGV0IHNlcGVyYXRvciA9ICcvJ1xyXG4gICAgICBpZihSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5zZXBlcmF0b3IpXHJcbiAgICAgICAgc2VwZXJhdG9yID0gUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uc2VwZXJhdG9yO1xyXG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2Uoc2VwZXJhdG9yLCctJykucmVwbGFjZShzZXBlcmF0b3IsJy0nKTtcclxuICAgICAgcmV0dXJuIHRoaXMucmVnZXgoKS50ZXN0KHZhbHVlKTtcclxuICAgIH1lbHNlXHJcbiAgICAgIHJldHVybiB0aGlzLmlzRGF0ZSh2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBnZXRDb25maWdEYXRlVmFsdWUoY29uZmlnKXtcclxuICAgIGxldCBkYXRlID0gY29uZmlnLnZhbHVlO1xyXG4gICAgaWYoY29uZmlnLnZhbHVlICYmIHR5cGVvZiBjb25maWcudmFsdWUgPT0gXCJzdHJpbmdcIil7XHJcbiAgICAgIGRhdGUgPSB0aGlzLmdldERhdGUoY29uZmlnLnZhbHVlLHRydWUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRhdGU7XHJcbiAgfVxyXG5cclxuICAgZ2V0Q29tcGFyZURhdGUoY29uZmlnOmFueSxjb250cm9sOmFueSl7XHJcbiAgICAgICAgICBsZXQgZGF0ZSA9IHRoaXMuZ2V0Q29uZmlnRGF0ZVZhbHVlKGNvbmZpZyk7XHJcbiAgICAgICAgICBpZihjb25maWcuZmllbGROYW1lKXtcclxuICAgICAgICAgICAgbGV0IGNoZWNrQ29udHJvbCA6IGFueSA9IEFwcGxpY2F0aW9uVXRpbC5nZXRGb3JtQ29udHJvbChjb25maWcuZmllbGROYW1lLGNvbnRyb2wpO1xyXG4gICAgICAgICAgICAgIGlmKGNoZWNrQ29udHJvbCAmJiBjaGVja0NvbnRyb2wudmFsdWUpe1xyXG4gICAgICAgICAgICAgICAgICBkYXRlID0gdGhpcy5nZXREYXRlKGNoZWNrQ29udHJvbC52YWx1ZSlcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkYXRlO1xyXG4gIH1cclxufVxyXG4iXX0=